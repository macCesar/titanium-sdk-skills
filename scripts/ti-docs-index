#!/bin/bash

#############################################
# Titanium AGENTS.md Installer
# Based on Vercel's AGENTS.md research
# https://vercel.com/blog/agents-md-outperforms-skills-in-our-agent-evals
#############################################

set -e

# Version marker for detection/replacement
TITANIUM_KNOWLEDGE_VERSION="v1.0.0"
BLOCK_START="<!-- TITANIUM-KNOWLEDGE-${TITANIUM_KNOWLEDGE_VERSION} -->"
BLOCK_END="<!-- END-TITANIUM-KNOWLEDGE -->"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

PROJECT_ROOT=$(pwd)
TEMPLATE="$HOME/.agents/AGENTS-TEMPLATE.md"

# Header - minimal output
echo -e "${BLUE}Titanium AGENTS.md Installer${NC}"
echo ""

# Verify template exists
if [ ! -f "$TEMPLATE" ]; then
    echo -e "${RED}Error: AGENTS-TEMPLATE.md not found${NC}"
    echo "Install titanium-sdk-skills first:"
    echo "  curl -fsSL https://raw.githubusercontent.com/macCesar/titanium-sdk-skills/main/install.sh | bash"
    exit 1
fi

# Verify this is a Titanium project
if [ ! -f "tiapp.xml" ]; then
    echo -e "${RED}Error: Not a Titanium project (no tiapp.xml)${NC}"
    echo "Run this command from your project root."
    exit 1
fi

# Detect Titanium version
detect_titanium_version() {
    local version=$(grep -o '<sdk-version>[^<]*' tiapp.xml 2>/dev/null | sed 's/<sdk-version>//' | head -1)
    [ -z "$version" ] && version="unknown"
    echo "$version"
}

TI_VERSION=$(detect_titanium_version)
echo -e "${GREEN}✓${NC} Titanium project (SDK $TI_VERSION)"
echo ""

# Check which AI files exist
CLAUDE_EXISTS=false
AGENTS_EXISTS=false
GEMINI_EXISTS=false

[ -f "$PROJECT_ROOT/CLAUDE.md" ] && CLAUDE_EXISTS=true
[ -f "$PROJECT_ROOT/AGENTS.md" ] && AGENTS_EXISTS=true
[ -f "$PROJECT_ROOT/GEMINI.md" ] && GEMINI_EXISTS=true

# Count how many exist
FILE_COUNT=0
[ "$CLAUDE_EXISTS" = true ] && FILE_COUNT=$((FILE_COUNT + 1))
[ "$AGENTS_EXISTS" = true ] && FILE_COUNT=$((FILE_COUNT + 1))
[ "$GEMINI_EXISTS" = true ] && FILE_COUNT=$((FILE_COUNT + 1))

# Function to check if Titanium knowledge block exists
block_exists() {
    local file="$1"
    grep -q "$BLOCK_START" "$file" 2>/dev/null
}

# Function to remove old block
remove_old_block() {
    local file="$1"
    local temp_file="${file}.tmp"

    # Remove everything between the markers (inclusive)
    sed "/${BLOCK_START}/,/${BLOCK_END}/d" "$file" > "$temp_file"
    mv "$temp_file" "$file"
}

# Function to add Titanium knowledge block
add_titanium_knowledge() {
    local target="$1"
    local temp_file="${target}.tmp"

    # Create the knowledge block
    cat > /tmp/titanium_knowledge_block.md << 'BLOCKCONTENT'

<!-- TITANIUM-KNOWLEDGE-v1.0.0 -->
<!--
Titanium SDK Knowledge Index
Added by titanium-sdk-skills -->
Based on Vercel's research: https://vercel.com/blog/agents-md-outperforms-skills-in-our-agent-evals

IMPORTANT: Prefer retrieval-led reasoning over pre-training-led reasoning when working with Titanium SDK.
Always consult the documentation files below rather than relying on training data, which may be outdated.

This knowledge index is based on the latest Titanium SDK documentation.
-->

BLOCKCONTENT

    # Extract compressed index from template
    sed -n '/## Compressed Documentation Index/,/^---$/p' "$TEMPLATE" | sed '$d' >> /tmp/titanium_knowledge_block.md
    echo "" >> /tmp/titanium_knowledge_block.md
    echo "<!-- END-TITANIUM-KNOWLEDGE -->" >> /tmp/titanium_knowledge_block.md

    # Append to target file
    cat /tmp/titanium_knowledge_block.md >> "$target"
    rm -f /tmp/titanium_knowledge_block.md
}

# Function to update a file
update_file() {
    local target="$1"
    local filename=$(basename "$target")

    if block_exists "$target"; then
        # Remove old block and add new one
        remove_old_block "$target"
        add_titanium_knowledge "$target"
        echo -e "${GREEN}✓${NC} ${filename} updated"
    else
        # Add new block
        echo "" >> "$target"
        add_titanium_knowledge "$target"
        echo -e "${GREEN}✓${NC} ${filename} created/updated"
    fi
}

# Priority logic: CLAUDE.md > GEMINI.md > AGENTS.md
TARGETS_UPDATED=()

if [ "$CLAUDE_EXISTS" = true ]; then
    # Claude Code detected
    update_file "$PROJECT_ROOT/CLAUDE.md"
    TARGETS_UPDATED+=("CLAUDE.md")

    # Also update others if they exist
    if [ "$GEMINI_EXISTS" = true ]; then
        update_file "$PROJECT_ROOT/GEMINI.md"
        TARGETS_UPDATED+=("GEMINI.md")
    fi
    if [ "$AGENTS_EXISTS" = true ]; then
        update_file "$PROJECT_ROOT/AGENTS.md"
        TARGETS_UPDATED+=("AGENTS.md")
    fi

elif [ "$GEMINI_EXISTS" = true ]; then
    # Gemini CLI detected
    update_file "$PROJECT_ROOT/GEMINI.md"
    TARGETS_UPDATED+=("GEMINI.md")

    # Also update AGENTS.md if exists
    if [ "$AGENTS_EXISTS" = true ]; then
        update_file "$PROJECT_ROOT/AGENTS.md"
        TARGETS_UPDATED+=("AGENTS.md")
    fi

elif [ "$AGENTS_EXISTS" = true ]; then
    # Only AGENTS.md exists
    update_file "$PROJECT_ROOT/AGENTS.md"
    TARGETS_UPDATED+=("AGENTS.md")

else
    # No files exist - ask which AI they use
    echo "Which AI assistant are you using?"
    echo "  1) Claude Code (creates CLAUDE.md)"
    echo "  2) Gemini CLI (creates GEMINI.md)"
    echo "  3) Cursor/Copilot (creates AGENTS.md)"
    echo ""
    read -p "Choice [1/2/3]: " ai_choice

    case $ai_choice in
        1)
            touch "$PROJECT_ROOT/CLAUDE.md"
            update_file "$PROJECT_ROOT/CLAUDE.md"
            TARGETS_UPDATED+=("CLAUDE.md")
            ;;
        2)
            touch "$PROJECT_ROOT/GEMINI.md"
            update_file "$PROJECT_ROOT/GEMINI.md"
            TARGETS_UPDATED+=("GEMINI.md")
            ;;
        3)
            touch "$PROJECT_ROOT/AGENTS.md"
            update_file "$PROJECT_ROOT/AGENTS.md"
            TARGETS_UPDATED+=("AGENTS.md")
            ;;
        *)
            echo -e "${RED}Invalid choice, creating AGENTS.md${NC}"
            touch "$PROJECT_ROOT/AGENTS.md"
            update_file "$PROJECT_ROOT/AGENTS.md"
            TARGETS_UPDATED+=("AGENTS.md")
            ;;
    esac
fi

echo ""
echo -e "${GREEN}✓${NC} Done! Updated: ${TARGETS_UPDATED[*]}"
echo ""

# Show notes for other files
if [ "${#TARGETS_UPDATED[@]}" -gt 1 ]; then
    echo -e "${CYAN}Note:${NC} Updated ${#TARGETS_UPDATED[@]} files - Titanium knowledge synced across all."
fi
